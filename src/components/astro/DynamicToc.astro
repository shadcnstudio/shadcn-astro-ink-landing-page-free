---
interface Props {
  headings?: { depth: number; slug: string; text: string }[]
}

const { headings = [] } = Astro.props

// Filter to only h2 and h3 headings
const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3)

// Group h3 headings under their parent h2
interface TocItem {
  slug: string
  text: string
  depth: number
  children: TocItem[]
}

const groupedHeadings: TocItem[] = []
let currentH2: TocItem | null = null

let activeId = ''

tocHeadings.forEach(heading => {
  if (heading.depth === 2) {
    currentH2 = {
      slug: heading.slug,
      text: heading.text,
      depth: heading.depth,
      children: []
    }
    groupedHeadings.push(currentH2)
  } else if (heading.depth === 3 && currentH2) {
    currentH2.children.push({
      slug: heading.slug,
      text: heading.text,
      depth: heading.depth,
      children: []
    })
  }
})
---

{
  groupedHeadings.length > 0 && (
    <div class='sticky top-24'>
      <h3 class='text-foreground mb-3.5 font-medium'>On This Page</h3>
      <nav>
        <ul class='space-y-3'>
          {groupedHeadings.map(item => (
            <li>
              <a
                href={`#${item.slug}`}
                class={`toc-link flex items-start gap-2 text-left transition-colors ${activeId === item.slug ? 'text-foreground font-medium' : 'text-muted-foreground hover:text-foreground'}`}
              >
                <span
                  class={`bg-primary/40 mt-2.5 inline-block h-0.5 w-3 shrink-0 transition-colors ${activeId === item.slug ? 'bg-primary' : 'bg-primary/40'}`}
                />
                <span>{item.text}</span>
              </a>

              {item.children.length > 0 && (
                <ul class='mt-3 ml-5 space-y-3'>
                  {item.children.map(child => (
                    <li>
                      <a
                        href={`#${child.slug}`}
                        class={`toc-link flex items-start gap-2 text-left transition-colors ${activeId === child.slug ? 'text-foreground font-medium' : 'text-muted-foreground hover:text-foreground'}`}
                      >
                        <span
                          class={`bg-primary/40 mt-2.5 inline-block h-0.5 w-3 shrink-0 transition-colors ${activeId === child.slug ? 'bg-primary' : 'bg-primary/40'}`}
                        />
                        <span>{child.text}</span>
                      </a>
                    </li>
                  ))}
                </ul>
              )}
            </li>
          ))}
        </ul>
      </nav>
    </div>
  )
}

<script>
  // Smooth scroll behavior and active link highlighting
  document.addEventListener('DOMContentLoaded', () => {
    const links = document.querySelectorAll('.toc-link')
    const sections = document.querySelectorAll('h2, h3')
    let activeId = ''

    // Add click event for smooth scrolling
    links.forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault()
        const href = link.getAttribute('href')
        if (href) {
          const target = document.querySelector(href)
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' })
            activeId = href.substring(1)
            updateActiveLink()
          }
        }
      })
    })

    // Highlight active link based on scroll position
    const observerCallback = (entries: IntersectionObserverEntry[]) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          activeId = entry.target.id
          updateActiveLink()
        }
      })
    }

    const observerOptions = {
      root: null,
      rootMargin: '-20% 0px -70% 0px', // Adjust as needed
      threshold: 0
    }

    const observer = new IntersectionObserver(observerCallback, observerOptions)

    sections.forEach(section => {
      observer.observe(section)
    })

    const updateActiveLink = () => {
      links.forEach(link => {
        const linkHref = link.getAttribute('href')
        if (linkHref === `#${activeId}`) {
          link.classList.add('font-medium', 'text-foreground')
          link.classList.remove('text-muted-foreground')
        } else {
          link.classList.remove('font-medium', 'text-foreground')
          link.classList.add('text-muted-foreground')
        }
      })
    }
  })
</script>
